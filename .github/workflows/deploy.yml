name: CI/CD Pipeline

on:
  push:
    branches:
      - work/final-work_9

jobs:
  ci:
    name: ðŸ” Run Tests and Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install flake8 psycopg[binary]
          pip install -r requirements.txt

      - name: Run linter (flake8)
        run: |
          flake8 . --exclude=env,migrations,__pycache__

      - name: ðŸ§ª Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹
        run: |
          python manage.py test --settings=config.settings
        env:
          SECRET_KEY: dummykey
          DEBUG: "False"
          DB_NAME: habitflow_db
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
          TELEGRAM_BOT_TOKEN: test_token
          CELERY_BROKER_URL: redis://localhost:6379/0
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: habitflow_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd=pg_isready
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
       image: redis:7
       ports:
         - 6379:6379

  build:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: |
          docker build --target backend -t myapp-backend:latest .

      - name: Build celery image
        run: |
          docker build --target celery -t myapp-celery:latest .

  deploy:
    name: ðŸš€ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: [ci, build]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Configure SSH Agent
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ–¥ï¸ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð´Ð¾Ð¼Ð°ÑˆÐ½ÑŽÑŽ Ð¿Ð°Ð¿ÐºÑƒ
            cd /home/${{ secrets.SSH_USERNAME }} || exit

            # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð°Ð¿ÐºÑƒ habitflow Ð¸ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            if [ ! -d "habitflow" ]; then
              echo "ðŸ“ ÐŸÐ°Ð¿ÐºÐ° habitflow Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÑŽ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
              git clone https://github.com/oksanafedorova07/HabitFlow.git habitflow
            fi

            cd habitflow || exit

            # Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            git fetch origin work/final-work_9

            # ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð½Ð° Ð²ÐµÑ‚ÐºÑƒ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ
            git checkout work/final-work_9
            git pull origin work/final-work_9

            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .env Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
            cat > .env << EOF
            DEBUG=${{ secrets.DEBUG }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            DB_HOST=db
            DB_NAME=habitflow_db
            DB_USER=postgres
            REDIS_URL=redis://redis:6379/0
            CELERY_BROKER_URL=redis://redis:6379/0
            EOF

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÑ‹
            echo "ðŸ”„ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            docker-compose down

            echo "ðŸ—ï¸ ÐŸÐµÑ€ÐµÑÐ¾Ð±Ð¸Ñ€Ð°ÑŽ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            docker-compose up -d --build

            # ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÑŽ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸..."
            docker-compose run --rm backend python manage.py migrate --noinput

            # Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ
            echo "ðŸ“¦ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ..."
            docker-compose run --rm backend python manage.py collectstatic --noinput

            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
